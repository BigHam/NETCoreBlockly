<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Blockly swagger demo</title>
    <script src="/blockly/acorn_interpreter.js"></script>

    <!--<script src="/blockly/acorn.js"></script>
    <script src="/blockly/interpreter.js"></script>-->

    <script src="/blockly/blockly_compressed.js"></script>
    <script src="/blockly/blocks_compressed.js"></script>
    <script src="/blockly/javascript_compressed.js"></script>
    <script src="/blockly/en.js"></script>
    <script src="/blockly/wait_block.js"></script>
    <script src="/blockly/window/open.js"></script>
    <script src="blockly/Http/ifxhr.js"></script>
    <script src="blockly/blocklyControls.js"></script>
    <script src="others/jszip.min.js"></script>
    <script src="others/FileSaver.min.js"></script>
    <script src="blockly/Http/BlocklyXHRWrapper.js"></script>
    <script src="blockly/converters/convertCSV.js"></script>
    <script src="blockly/exporters/exportFile.js"></script>
    <script src="blockly/DateTime/DateTime.js"></script>
    <script src="blockly/DateTime/CurrentDateBlock.js"></script>
    <script src="/blockly/Http/blocklyXHR.js"></script>
    <script src="/blockly/Http/blocklyHeader.js"></script>
    <!--this is generated at runtime by blockly storage nuget : local storage, sqlite...-->
    <script src="/blocklyStorage"></script>

    <!--doNotCopyToFinal-->
    <script src="doNotCopy/testing.js"></script>
    <script src="doNotCopy/JRTemplating.js"></script>
    <!--enddoNotCopyToFinal-->
    <style>
        body {
            background-color: #fff;
            font-family: sans-serif;
        }

        h1 {
            font-weight: normal;
            font-size: 140%;
        }
        /*doNotCopyToFinal*/
        ul li {
            display: inline-block;
        }
        /*enddoNotCopyToFinal*/
    </style>
</head>
<body>
    <h1>
        Blockly Swagger
    </h1>
    <!--doNotCopyToFinal-->
    <p>
        <a href='https://github.com/ignatandrei/NETCoreBlockly' target='_blank'>Source code</a>
        <a href='https://www.youtube.com/watch?v=GptkNWjmCzk' target='_blank'>Demo Video</a>
    </p>
    <!--enddoNotCopyToFinal-->

    <script src="/blocklyDefinitions"></script>
    <script src="/BlocklyToolBoxValueDefinitions"></script>
    <script src="/blocklyAPIFunctions"></script>
    <script src="/BlocklyToolBoxFunctionDefinitions"></script>
    <script src="/BlocklySwaggers"></script>
    <p>
        <button onclick="runCode()" id="runButton" style="width:300px">E X E C U T E !</button>

        <!--<a href="javascript:downloadZip()">Download Results</a>-->
        <a href="javascript:SaveBlocks()" id="saveBlocks">Save Blocks</a>
        <a href="javascript:ShowInnerWorkings()">Show blocks</a>
    </p>

    <div style="width: 100%">
        <div id="blocklyDiv"
             style="display: inline-block; height: 480px; width: 58%"></div>
        <textarea id="output"
                  style="display: inline-block; height: 480px; width: 38%;">
      
    </textarea>

    </div>
    <!--doNotCopyToFinal-->
    Saved
    <ul id="localStorageSaved">
    </ul>

    <script type="text/html" id="storage_tmpl">
        <% for ( var i = 0; i < data.length; i++ ) { %>
        <li><%=(i+1)%>) <a href="javascript:LoadFromStorage('<%=i%>')"> <%=data[i].name%> </a></li>
        <% } %>

    </script>


    <div id="doNotCopy">
        Testing blocks:
        <ul id="results">
        </ul>

        <script type="text/html" id="data_tmpl">
            <% for ( var i = 0; i < data.length; i++ ) { %>
            <li><%=(i+1)%>) <a href="javascript:Loadtesting('<%=i%>')"><%= data[i].name %></a></li>
            <% } %>

        </script>
        <button onclick="javascript:executeAll()" id="executeAll">Execute all testing</button>

    </div>
    <!--enddoNotCopyToFinal-->
    <script>
        var _lsh = null;
        function lsh() {
            if (_lsh) {
                return _lsh;
            }
            _lsh = new StorageHandler();
            console.log(_lsh.name);
            document.getElementById("saveBlocks").title = `storage : ${_lsh.name}`;
            return _lsh;
        }
        function LoadFromStorage(i) {
            //window.alert(arrSavedLocalStorage[i]);
            var ls = getBlocksFromLocalStorage();
            demoWorkspace.clear();
            var content = ls[i].val;
            //window.alert(content);
            var dom = Blockly.Xml.textToDom(content);
            Blockly.Xml.domToWorkspace(dom, demoWorkspace);
            resetStepUi();

        }

        function Loadtesting(id) {
            demoWorkspace.clear();
            var content =testBlocks[id].data;
            var dom = Blockly.Xml.textToDom(content);
            Blockly.Xml.domToWorkspace(dom, demoWorkspace);
            resetStepUi();
            runCode();
        }
        /*doNotCopyToFinal*/
        var results = document.getElementById("results");
        results.innerHTML = tmpl("data_tmpl", { data: testBlocks });
        var nrToExecute;
        var runnerAll = function () {

            nrToExecute = nrToExecute + 1;
            console.log(nrToExecute);
            var waitSecs = 1;
            if (window.confirm(`execute ${testBlocks[nrToExecute].name}  step ${nrToExecute + 1}  from ${testBlocks.length}?`)) {
                waitSecs = waitSecs * 5;
                Loadtesting(nrToExecute);
            }

            waitSecs = waitSecs * 1000;
            if (nrToExecute < testBlocks.length)
                setTimeout(runnerAll, waitSecs);
            else
                document.getElementById('executeAll').disabled = '';
        }

        function executeAll() {
            nrToExecute = -1;
            document.getElementById('executeAll').disabled = 'disabled';
            console.log('before');
            runnerAll();


        }
        /*enddoNotCopyToFinal*/

    </script>
    <xml id="toolbox" style="display: none">
        <category name="LocalSite" expanded="false">
            <category id="LocalSiteFunctions" name="LocalSiteFunctions" expanded="true">
            </category>
            <category custom="LocalSiteValues" name="LocalSiteValues">
            </category>


        </category>
        <sep></sep>
        <category name="OtherSwagggers"></category>
        <category custom="savedBlocks" name="Saved Blocks" >

        </category>

        <category name="BlocklyCore">

            <category id="catLogic" colour="210" name="Logic">
                <block type="controls_if"></block>
                <block type="logic_compare"></block>
                <block type="logic_operation"></block>
                <block type="logic_negate"></block>
                <block type="logic_boolean"></block>
                <block type="logic_null"></block>
                <block type="logic_ternary"></block>
            </category>
            <category id="catLoops" colour="120" name="Loops">
                <block type="controls_repeat_ext">
                    <value name="TIMES">
                        <shadow type="math_number">
                            <field name="NUM">10</field>
                        </shadow>
                    </value>
                </block>
                <block type="controls_whileUntil"></block>
                <block type="controls_for">
                    <value name="FROM">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                    <value name="TO">
                        <shadow type="math_number">
                            <field name="NUM">10</field>
                        </shadow>
                    </value>
                    <value name="BY">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                </block>
                <block type="controls_forEach"></block>
                <block type="controls_flow_statements"></block>
            </category>
            <category id="catMath" colour="230" name="Math">
                <block type="math_number"></block>
                <block type="math_arithmetic">
                    <value name="A">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                    <value name="B">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_single">
                    <value name="NUM">
                        <shadow type="math_number">
                            <field name="NUM">9</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_trig">
                    <value name="NUM">
                        <shadow type="math_number">
                            <field name="NUM">45</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_constant"></block>
                <block type="math_number_property">
                    <value name="NUMBER_TO_CHECK">
                        <shadow type="math_number">
                            <field name="NUM">0</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_change">
                    <value name="DELTA">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_round">
                    <value name="NUM">
                        <shadow type="math_number">
                            <field name="NUM">3.1</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_on_list"></block>
                <block type="math_modulo">
                    <value name="DIVIDEND">
                        <shadow type="math_number">
                            <field name="NUM">64</field>
                        </shadow>
                    </value>
                    <value name="DIVISOR">
                        <shadow type="math_number">
                            <field name="NUM">10</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_constrain">
                    <value name="VALUE">
                        <shadow type="math_number">
                            <field name="NUM">50</field>
                        </shadow>
                    </value>
                    <value name="LOW">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                    <value name="HIGH">
                        <shadow type="math_number">
                            <field name="NUM">100</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_random_int">
                    <value name="FROM">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                    <value name="TO">
                        <shadow type="math_number">
                            <field name="NUM">100</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_random_float"></block>
            </category>
            <category id="catText" colour="160" name="Text">
                <block type="text"></block>
                <block type="text_join"></block>
                <block type="text_append">
                    <value name="TEXT">
                        <shadow type="text"></shadow>
                    </value>
                </block>
                <block type="text_length">
                    <value name="VALUE">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_isEmpty">
                    <value name="VALUE">
                        <shadow type="text">
                            <field name="TEXT"></field>
                        </shadow>
                    </value>
                </block>
                <block type="text_indexOf">
                    <value name="VALUE">
                        <block type="variables_get">
                            <field name="VAR">text</field>
                        </block>
                    </value>
                    <value name="FIND">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_charAt">
                    <value name="VALUE">
                        <block type="variables_get">
                            <field name="VAR">text</field>
                        </block>
                    </value>
                </block>
                <block type="text_getSubstring">
                    <value name="STRING">
                        <block type="variables_get">
                            <field name="VAR">text</field>
                        </block>
                    </value>
                </block>
                <block type="text_changeCase">
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_trim">
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_print">
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_prompt_ext">
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
            </category>
            <category id="catLists" colour="260" name="Lists">
                <block type="lists_create_with">
                    <mutation items="0"></mutation>
                </block>
                <block type="lists_create_with"></block>
                <block type="lists_repeat">
                    <value name="NUM">
                        <shadow type="math_number">
                            <field name="NUM">5</field>
                        </shadow>
                    </value>
                </block>
                <block type="lists_length"></block>
                <block type="lists_isEmpty"></block>
                <block type="lists_indexOf">
                    <value name="VALUE">
                        <block type="variables_get">
                            <field name="VAR">list</field>
                        </block>
                    </value>
                </block>
                <block type="lists_getIndex">
                    <value name="VALUE">
                        <block type="variables_get">
                            <field name="VAR">list</field>
                        </block>
                    </value>
                </block>
                <block type="lists_setIndex">
                    <value name="LIST">
                        <block type="variables_get">
                            <field name="VAR">list</field>
                        </block>
                    </value>
                </block>
                <block type="lists_getSublist">
                    <value name="LIST">
                        <block type="variables_get">
                            <field name="VAR">list</field>
                        </block>
                    </value>
                </block>
                <block type="lists_split">
                    <value name="DELIM">
                        <shadow type="text">
                            <field name="TEXT">,</field>
                        </shadow>
                    </value>
                </block>
                <block type="lists_sort"></block>
            </category>
            <category id="catColour" colour="20" name="Color">
                <block type="colour_picker"></block>
                <block type="colour_random"></block>
                <block type="colour_rgb">
                    <value name="RED">
                        <shadow type="math_number">
                            <field name="NUM">100</field>
                        </shadow>
                    </value>
                    <value name="GREEN">
                        <shadow type="math_number">
                            <field name="NUM">50</field>
                        </shadow>
                    </value>
                    <value name="BLUE">
                        <shadow type="math_number">
                            <field name="NUM">0</field>
                        </shadow>
                    </value>
                </block>
                <block type="colour_blend">
                    <value name="COLOUR1">
                        <shadow type="colour_picker">
                            <field name="COLOUR">#ff0000</field>
                        </shadow>
                    </value>
                    <value name="COLOUR2">
                        <shadow type="colour_picker">
                            <field name="COLOUR">#3333ff</field>
                        </shadow>
                    </value>
                    <value name="RATIO">
                        <shadow type="math_number">
                            <field name="NUM">0.5</field>
                        </shadow>
                    </value>
                </block>
            </category>
            <category id="catVariables" colour="330" custom="VARIABLE" name="Variables"></category>
            <category id="catFunctions" colour="290" custom="PROCEDURE" name="Functions"></category>
        </category>
        <sep></sep>
        <category name="advanced">

            <category id="catJSON" colour="160" name="Converters">
                <!--                <button text="A button" callbackKey="crae"></button>-->
                <block type="converttojson"></block>
                <block type="converttostring"></block>
                <block type="convertcsv">

                </block>
            </category>
            <category id="catExporter" colour="160" name="Exporter">
                <!--                <button text="A button" callbackKey="crae"></button>-->
                <block type="exportfile">
                    <value name="fileName">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                    <value name="convertToByte">
                        <shadow type="logic_boolean">
                            <field name="BOOL">FALSE</field>
                        </shadow>
                    </value>



                </block>

            </category>
            <category id="JavaScriptRelated" name="JSBlocks">
                <!--<block type="wait_seconds"></block>-->
                <category name="Objects" id="Objects">
                    <block type="modifyproperty"></block>
                    <block type="getproperty"></block>
                </category>
                <category name="DateTime" id="DateTime">
                    <block type="fromUnixTimeToDate">
                        <value name="VALUE">
                            <shadow type="math_number">
                                <field name="NUM">9072000</field>
                            </shadow>
                        </value>
                    </block>
                    <block type="displayCurrentDate">
                    </block>
                </category>

            </category>
            <category id="XHR" name="Request">
                <block type="headersbeforehttp">
                    <value name="HttpDomain">
                        <shadow type="text">
                            <field name="TEXT">(localSite)</field>
                        </shadow>
                    </value>
                    <value name="HeaderName">
                        <shadow type="text">
                            <field name="TEXT">Authorization</field>
                        </shadow>
                    </value>
                    <value name="HeaderValue">
                        <shadow type="text_join">

                        </shadow>
                    </value>
                </block>
                <block type="blockxhrresult"></block>
                <block type="httprequest">
                    <value name="TheUrl">
                        <shadow type="text">
                            <field name="TEXT">https://api.chucknorris.io/jokes/random</field>
                        </shadow>
                    </value>
                </block>
            </category>
            <category id="Controls" name="GUI">
                <block type="window_open"></block>
                <block type="valuefromtext">
                    <value name="IdOfText">
                        <shadow type="text">
                            <field name="TEXT">output</field>
                        </shadow>
                    </value>
                    <value name="ValueToObtain">
                        <shadow type="text">
                            <field name="TEXT">value</field>
                        </shadow>
                    </value>
                </block>
            </category>

            <category id="catHelpers" colour="160" name="Helpers">
                <block type="wait_seconds"></block>
                <block type="text_print">
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_prompt_ext">
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
            </category>
        </category>

    </xml>

    <xml xmlns="https://developers.google.com/blockly/xml" id="startBlocks" style="display: none">
        <block type="variables_set" id="set_n_initial" inline="true" x="20" y="20">
            <field name="VAR">n</field>
            <value name="VALUE">
                <block type="math_number">
                    <field name="NUM">1</field>
                </block>
            </value>
            <next>
                <block type="controls_repeat_ext" id="repeat" inline="true">
                    <value name="TIMES">
                        <block type="math_number">
                            <field name="NUM">4</field>
                        </block>
                    </value>
                    <statement name="DO">
                        <block type="variables_set" id="set_n_update" inline="true">
                            <field name="VAR">n</field>
                            <value name="VALUE">
                                <block type="math_arithmetic" inline="true">
                                    <field name="OP">MULTIPLY</field>
                                    <value name="A">
                                        <block type="variables_get">
                                            <field name="VAR">n</field>
                                        </block>
                                    </value>
                                    <value name="B">
                                        <block type="math_number">
                                            <field name="NUM">2</field>
                                        </block>
                                    </value>
                                </block>
                            </value>
                            <next>
                                <block type="text_print" id="print">
                                    <value name="TEXT">
                                        <block type="variables_get">
                                            <field name="VAR">n</field>
                                        </block>
                                    </value>
                                </block>
                            </next>
                        </block>
                    </statement>
                </block>
            </next>
        </block>

    </xml>
    <!--doNotCopyToFinal-->
    <xml id="testSite" style="display: none">
        <block type="variables_set" id="set_n_initial" inline="true" x="20" y="20">
            <field name="VAR">n</field>
            <value name="VALUE">
                <block type="math_number">
                    <field name="NUM">1</field>
                </block>
            </value>
            <next>

                <block type="controls_repeat_ext" id="repeat" inline="true">
                    <value name="TIMES">
                        <block type="math_number">
                            <field name="NUM">2</field>
                        </block>
                    </value>

                    <statement name="DO">
                        <block type="wait_seconds" id="wait">
                            <field name="SECONDS">1.0</field>
                            <next>
                                <block type="variables_set" id="set_n_update" inline="true">
                                    <field name="VAR">n</field>
                                    <value name="VALUE">
                                        <block type="math_arithmetic" inline="true">
                                            <field name="OP">MULTIPLY</field>
                                            <value name="A">
                                                <block type="variables_get">
                                                    <field name="VAR">n</field>
                                                </block>
                                            </value>
                                            <value name="B">
                                                <block type="math_number">
                                                    <field name="NUM">2</field>
                                                </block>
                                            </value>
                                        </block>
                                    </value>
                                    <next>
                                        <block type="text_print" id="print1" inline="false">
                                            <value name="TEXT">
                                                <block type="api_MyTest_AddValues_POST">
                                                    <value name="val_sumargs">
                                                        <block type="TestWebAPISite_Controllers_SumArgs">
                                                            <value name="val_x">
                                                                <shadow type="math_number">
                                                                    <field name="NUM">10</field>
                                                                </shadow>
                                                            </value>
                                                            <value name="val_y">
                                                                <block type="variables_get">
                                                                    <field name="VAR">n</field>
                                                                </block>
                                                            </value>

                                                        </block>
                                                    </value>
                                                </block>

                                            </value>
                                            <next>
                                                <block type="text_print" id="print2" inline="false">
                                                    <value name="TEXT">
                                                        <block type="converttojson">
                                                            <value name="ValueToConvert">
                                                                <block type="api_MathAdd_GET"></block>
                                                            </value>
                                                        </block>

                                                    </value>
                                                    <next>
                                                        <block type="text_print" id="print3" inline="false">
                                                            <value name="TEXT">
                                                                <block type="api_MathAdd__id__GET">
                                                                    <value name="val_id">
                                                                        <block type="variables_get">
                                                                            <field name="VAR">n</field>
                                                                        </block>

                                                                    </value>
                                                                </block>
                                                            </value>
                                                            <next>
                                                                <block type="text_print" id="print3" inline="false">
                                                                    <value name="TEXT">

                                                                        <block type="api_MathAdd_POST">
                                                                            <value name="val_value"><shadow type="text"><field name="TEXT">abc</field></shadow></value>
                                                                        </block>
                                                                    </value>
                                                                    <next>
                                                                        <block type="text_print" id="print3" inline="false">
                                                                            <value name="TEXT">

                                                                                <block type="api_MathAdd__id__PUT">
                                                                                    <value name="val_value"><shadow type="text"><field name="TEXT">abc</field></shadow></value>
                                                                                    <value name="val_id">
                                                                                        <block type="variables_get">
                                                                                            <field name="VAR">n</field>
                                                                                        </block>

                                                                                    </value>
                                                                                </block>
                                                                            </value>
                                                                            <next>
                                                                                <block type="text_print" id="print3" inline="false">
                                                                                    <value name="TEXT">

                                                                                        <block type="api_MathAdd__id__DELETE">
                                                                                            <value name="val_id">
                                                                                                <block type="variables_get">
                                                                                                    <field name="VAR">n</field>
                                                                                                </block>

                                                                                            </value>
                                                                                        </block>
                                                                                    </value>
                                                                                    <next>
                                                                                        <block type="text_print" id="print3" inline="false">
                                                                                            <value name="TEXT">
                                                                                                <block type="WeatherForecast_GET">
                                                                                                </block>
                                                                                            </value>
                                                                                        </block>
                                                                                    </next>
                                                                                </block>
                                                                            </next>
                                                                        </block>

                                                                    </next>
                                                                </block>

                                                            </next>
                                                        </block>
                                                    </next>

                                                </block>

                                            </next>

                                        </block>

                                    </next>
                                </block>
                            </next>
                        </block>
                    </statement>
                </block>
            </next>
        </block>
    </xml>
    <!--enddoNotCopyToFinal-->

    <script>

        if (typeof blockTextLocalSiteFunctions === 'undefined') {
            window.alert('  the blockly  functions are not generated yet. Please refresh the page ');
        }

        function registerSavedBlocks() {
            var xmlList = [];
            var fromStorage = getBlocksFromLocalStorage();
            for (var i = 0; i < fromStorage.length; i++) {
                var storage = fromStorage[i];
                try {
                    var data = storage.val;
                    data = data.replace("</xml>", "");
                    data = data.replace('<xml xmlns="https://developers.google.com/blockly/xml">', '');
                    const vars = "</variables>";
                    var indexVar = data.indexOf(vars);
                    if (indexVar > 0) {
                        data = data.substr(indexVar + vars.length);
                    }
                    data = Blockly.Xml.textToDom(data);
                    xmlList.push(data);
                    //console.log(data);
                }
                catch (e) {
                    console.log("start error");
                    console.log(e);
                    console.log(storage);
                    console.log("end error");
                }
                //window.alert(xmlList.length);
            }
            //var blockText_Math2Values = '<block type="TestBlocklyHtml_Math2Values">';


            //var blockTextLocalSiteFunctions = '<value name="val_x"><shadow type="math_number"></shadow></value>';
            //blockText_Math2Values += blockTextLocalSiteFunctions;

            //var blockTextLocalSiteFunctions = '<value name="val_y"><shadow type="math_number"></shadow></value>';
            //blockText_Math2Values += blockTextLocalSiteFunctions; blockText_Math2Values += '</block>';
            //block_Math2Values = Blockly.Xml.textToDom(blockText_Math2Values);
            //xmlList.push(block_Math2Values);
            //var block_Math2ValuesSet = '<block type="variables_set"><field name="VAR">var_Math2Values</field></block>';
            //block_Math2ValuesSet = Blockly.Xml.textToDom(block_Math2ValuesSet);
            //xmlList.push(block_Math2ValuesSet);

            return xmlList;
        }

        var localSiteDom = document.getElementById("LocalSiteFunctions");
        localSiteDom.innerHTML = blockTextLocalSiteFunctions;


        Blockly.Blocks['converttojson'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("ConvertToJSON");
                this.appendValueInput("ValueToConvert")
                    .setCheck(null);
                this.setInputsInline(true);
                this.setOutput(true, null);
                this.setTooltip("Convert to JSON");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['converttojson'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("ConvertToJSON");
                this.appendValueInput("ValueToConvert")
                    .setCheck(null);
                this.setInputsInline(true);
                this.setOutput(true, null);
                this.setTooltip("Convert to JSON");
                this.setHelpUrl("");
            }
        };
        Blockly.JavaScript['converttojson'] = function (block) {
            var value_ValueToConvert = Blockly.JavaScript.valueToCode(block, 'ValueToConvert', Blockly.JavaScript.ORDER_ATOMIC);
            //value_ValueToConvert = value_ValueToConvert.replace(/(\r\n|\n|\r)/gm, "")
            const code = 'JSON.parse(' + value_ValueToConvert + ')';
            return [code, Blockly.JavaScript.ORDER_NONE];

        };
        Blockly.Blocks['converttostring'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("ConvertToString");
                this.appendValueInput("ValueToConvert")
                    .setCheck(null);
                this.setInputsInline(true);
                this.setOutput(true, null);
                this.setTooltip("Convert to String");
                this.setHelpUrl("");
            }
        };
        Blockly.JavaScript['converttostring'] = function (block) {
            var value_ValueToConvert = Blockly.JavaScript.valueToCode(block, 'ValueToConvert', Blockly.JavaScript.ORDER_ATOMIC);
            var code = 'JSON.stringify(' + value_ValueToConvert + ')';
            return [code, Blockly.JavaScript.ORDER_NONE];
        };

        //https://blockly-demo.appspot.com/static/demos/blockfactory/index.html#7jmg3m
        Blockly.Blocks['modifyproperty'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Modify ");
                this.appendValueInput("ObjectToChange")
                    .setCheck(null)
                    .setAlign(Blockly.ALIGN_CENTRE)
                    .appendField(new Blockly.FieldLabelSerializable("object"), "objectName");
                this.appendValueInput("PropertyName")
                    .setCheck(null)
                    .setAlign(Blockly.ALIGN_RIGHT)
                    .appendField(new Blockly.FieldLabelSerializable(",property"), "prop");
                this.appendValueInput("NewValue")
                    .setCheck(null)
                    .setAlign(Blockly.ALIGN_RIGHT)
                    .appendField(new Blockly.FieldLabelSerializable("toValue"), "newValue");
                this.setInputsInline(true);
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };
        Blockly.JavaScript['modifyproperty'] = function (block) {
            var value_objecttochange = Blockly.JavaScript.valueToCode(block, 'ObjectToChange', Blockly.JavaScript.ORDER_ATOMIC);
            var value_propertyname = Blockly.JavaScript.valueToCode(block, 'PropertyName', Blockly.JavaScript.ORDER_ATOMIC);
            var value_newvalue = Blockly.JavaScript.valueToCode(block, 'NewValue', Blockly.JavaScript.ORDER_ATOMIC);
            var code = value_objecttochange + "[" + value_propertyname + ']=' + value_newvalue + ";";
            return code;
        };

        Blockly.Blocks['getproperty'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Get from");
                this.appendValueInput("ObjectToChange")
                    .setCheck(null)
                    .setAlign(Blockly.ALIGN_CENTRE)
                    .appendField(new Blockly.FieldLabelSerializable("object"), "objectName");
                this.appendValueInput("PropertyName")
                    .setCheck(null)
                    .setAlign(Blockly.ALIGN_RIGHT)
                    .appendField(new Blockly.FieldLabelSerializable("property"), "prop");
                this.setInputsInline(true);
                this.setOutput(true, null)
                //this.setTooltip("");
                //this.setHelpUrl("");
            }

        };
        Blockly.JavaScript['getproperty'] = function (block) {
            var value_objecttochange = Blockly.JavaScript.valueToCode(block, 'ObjectToChange', Blockly.JavaScript.ORDER_ATOMIC);
            var value_propertyname = Blockly.JavaScript.valueToCode(block, 'PropertyName', Blockly.JavaScript.ORDER_ATOMIC);

            var code = value_objecttochange + "[" + value_propertyname + ']';
            // TODO: Change ORDER_NONE to the correct strength.
            return [code, Blockly.JavaScript.ORDER_NONE];
        };
        //swagger

        //window.alert(JSON.stringify(dictSwagger));
        function addScript(src) {
            var s = document.createElement('script');
            s.setAttribute('src', src);
            document.body.appendChild(s);
        }
        var toolbox = document.getElementById('toolbox');
        var xmlString = '';
        for (var i = 0; i < dictSwagger.length; i++) {
            var nameSwagger = dictSwagger[i].key;
            xmlString += `<category name="TEST${nameSwagger}" expanded="true">`;
            xmlString += `<category name="${nameSwagger} Functions" expanded="true"></category>`;
            xmlString += `<category name="${nameSwagger} Values"></category>`;
            xmlString += "</category>";
            addScript(`/BlocklyDefinitions${nameSwagger}`);
        }
        
        var html = toolbox.innerHTML.replace('<category name="OtherSwagggers"></category>', xmlString);
        toolbox.innerHTML = html;

        //end swagger


        demoWorkspace = Blockly.inject('blocklyDiv',
            {
                media: 'media/',
                toolbox: document.getElementById('toolbox')
            });
        if (glbVar)
            glbVar(demoWorkspace);
        //demoWorkspace.createVariable('var_SumArgs', 'TestWebAPISite_Controllers_SumArgs');
        demoWorkspace.registerToolboxCategoryCallback('LocalSiteValues', registerValues);
        demoWorkspace.registerToolboxCategoryCallback('savedBlocks', registerSavedBlocks);
        demoWorkspace.registerButtonCallback('crae',
            function (button) { Blockly.Variables.createVariable(button.getTargetWorkspace(), null, 'TestWebAPISite_Controllers_SumArgs'); }
        );
        //demoWorkspace.registerToolboxCategoryCallback('LocalSiteFunctions', registerFunctions);
        //function (ws) {
        //    //var tb = ws.getToolbox();
        //    //console.log(tb);
        //    //window.alert('adsa');
        //    registerFunctions();
        //    //var tb = demoWorkspace.getToolbox();
        //    //tb.refreshSelection();
        //});


        var urlParams = window.location.search.split('dom=');

        if (urlParams.length == 2) {
            var str = urlParams[1];
            var name = "savedBlockly_" + str;
            var xmlContent = lsh().get(name);

            //xmlContent = JSON.parse(xmlContent);
            xmlContent = xmlContent.val;
            if ((xmlContent || '').length > 0) {
                var dom = Blockly.Xml.textToDom(xmlContent);
                Blockly.Xml.domToWorkspace(dom, demoWorkspace);
            }
        }
        else {
            Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'), demoWorkspace);
        }
        //Blockly.Xml.domToWorkspace(document.getElementById('testSite'), demoWorkspace);

        //var tb = demoWorkspace.getToolbox();
        //console.log(tb.tree_);
        //tb.refreshSelection();
        //demoWorkspace.updateToolbox(tb);

        // Exit is used to signal the end of a script.
        Blockly.JavaScript.addReservedWords('exit');

        var outputArea = document.getElementById('output');
        var runButton = document.getElementById('runButton');
        var myInterpreter = null;
        var runner;

        function initApi(interpreter, globalObject) {

            var headersForDomain = interpreter.nativeToPseudo({ '(localSite)': [] });
            interpreter.setProperty(globalObject, 'headersForDomain', headersForDomain);


            // Add an API function for the alert() block, generated for "text_print" blocks.
            var wrapper = function (text) {
                console.log(text);
                text = text ? text.toString() : '';
                step++;

                console.log(`step ${step}`);
                zip.file(`result ${step}) ${text}`);
                outputArea.value = outputArea.value + '\n step' + step + ':' + text;
            };





            interpreter.setProperty(globalObject, 'alert',
                interpreter.createNativeFunction(wrapper));

            var wrapper = function (text) {
                window.open(text);
            };
            interpreter.setProperty(globalObject, 'open',
                interpreter.createNativeFunction(wrapper));

            // Add an API function for the prompt() block.
            var wrapper = function (text) {
                text = text ? text.toString() : '';
                return interpreter.createPrimitive(prompt(text));
            };
            interpreter.setProperty(globalObject, 'prompt',
                interpreter.createNativeFunction(wrapper));

            var wrapper = function (id, property) {

                return document.getElementById(id)[property];
            };
            interpreter.setProperty(globalObject, 'getIDProp',
                interpreter.createNativeFunction(wrapper));

            var wrapper = (item) => {
                outputArea.value += '\n error --' + '\n' + item + '\n error --';
            };

            interpreter.setProperty(globalObject, 'errHandler',
                interpreter.createNativeFunction(wrapper));


            //var wrapper = function (obj) {
            //    var json = JSON.parse(obj);
            //    var objNew = {};
            //    console.log(Blockly.mainWorkspace.getAllVariables());
            //    for (var key in json) {
            //        console.log(`evaluating ${key}`);
            //        objNew[key] = eval(json[key]);
            //        console.log(`finish ${key}`);
            //    }
            //    return objNew;
            //}
            //interpreter.setProperty(globalObject, 'resolveObject',
            //    interpreter.createNativeFunction(wrapper));
            var wrapper = (item) => convertCSV(item);
            interpreter.setProperty(globalObject, 'convertToCSV',
                interpreter.createNativeFunction(wrapper));

            var wrapper = (it, content, toByte) => exportToFile(it, content, toByte);
            interpreter.setProperty(globalObject, 'exportToFile',
                interpreter.createNativeFunction(wrapper));

            var wrapper = item => convertToDate(item);
            interpreter.setProperty(globalObject, 'convertToDate',
                interpreter.createNativeFunction(wrapper));

            var wrapper = () => displayDateCurrent();
            interpreter.setProperty(globalObject, 'displayDateCurrent',
                interpreter.createNativeFunction(wrapper));

            var wrapper = (href, callback) => {
                var heads = interpreter.pseudoToNative(headersForDomain);
                var hostname = '(localSite)';
                if (href.startsWith('http://') || href.startsWith('https://')) {
                    hostname = (new URL(href)).hostname;
                }
                var arrHeaders = [];
                if (hostname in heads) {
                    arrHeaders = heads[hostname];
                }
                return doGet(href, callback, arrHeaders);
            }
            interpreter.setProperty(globalObject, 'getXhr',
                interpreter.createAsyncFunction(wrapper));

            var wrapper = (href, objectToPost, callback) => {
                try {
                    var heads = interpreter.pseudoToNative(headersForDomain);
                    var hostname = '(localSite)';
                    if (href.startsWith('http://') || href.startsWith('https://')) {
                        hostname = (new URL(href)).hostname;
                    }
                    var arrHeaders = [];
                    if (hostname in heads) {
                        arrHeaders = heads[hostname];
                    }
                    doPost(href, objectToPost, callback);
                }
                catch (e) {
                    alert("is an error" + e);
                }
            };
            interpreter.setProperty(globalObject, 'postXhr',
                interpreter.createAsyncFunction(wrapper));

            var wrapper = (href, objectToPost, callback) => {
                try {
                    var heads = interpreter.pseudoToNative(headersForDomain);
                    var hostname = '(localSite)';
                    if (href.startsWith('http://') || href.startsWith('https://')) {
                        hostname = (new URL(href)).hostname;
                    }
                    var arrHeaders = [];
                    if (hostname in heads) {
                        arrHeaders = heads[hostname];
                    }
                    doPut(href, objectToPost, callback);
                }
                catch (e) {
                    alert("is an error" + e);
                }
            };
            interpreter.setProperty(globalObject, 'putXhr',
                interpreter.createAsyncFunction(wrapper));


            var wrapper = (href, callback) => {
                try {
                    var heads = interpreter.pseudoToNative(headersForDomain);
                    var hostname = '(localSite)';
                    if (href.startsWith('http://') || href.startsWith('https://')) {
                        hostname = (new URL(href)).hostname;
                    }
                    var arrHeaders = [];
                    if (hostname in heads) {
                        arrHeaders = heads[hostname];
                    }
                    doDelete(href, callback);
                }
                catch (e) {
                    alert("is an error" + e);
                }
            };



            interpreter.setProperty(globalObject, 'deleteXhr',
                interpreter.createAsyncFunction(wrapper));


            // Add an API for the wait block.  See wait_block.js
            initInterpreterWaitForSeconds(interpreter, globalObject);

            // Add an API function for highlighting blocks.
            var wrapper = function (id) {
                id = id ? id.toString() : '';
                return interpreter.createPrimitive(highlightBlock(id));
            };
            interpreter.setProperty(globalObject, 'highlightBlock',
                interpreter.createNativeFunction(wrapper));
        }

        var highlightPause = false;
        var latestCode = '';
        var step = 0;
        var zip = new JSZip();
        function highlightBlock(id) {

            demoWorkspace.highlightBlock(id);
            highlightPause = true;
        }

        function resetStepUi(clearOutput) {
            step = 0;

            demoWorkspace.highlightBlock(null);
            highlightPause = false;
            runButton.disabled = '';

            if (clearOutput) {
                zip = new JSZip();
                outputArea.value = 'Program output:\n=================';
            }
        }
        function ShowInnerWorkings() {

            var xml = Blockly.Xml.workspaceToDom(demoWorkspace, true);
            var xml_text = Blockly.Xml.domToPrettyText(xml);
            outputArea.value = "========\n";
            outputArea.value += xml_text;
            outputArea.value += "\n========\n";
            outputArea.value += latestCode;

        }
        function generateCodeAndLoadIntoInterpreter() {
            // Generate JavaScript code and parse it.
            Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
            Blockly.JavaScript.addReservedWords('highlightBlock');
            latestCode = Blockly.JavaScript.workspaceToCode(demoWorkspace);

            resetStepUi(true);


        }

        function resetInterpreter() {
            myInterpreter = null;
            if (runner) {
                clearTimeout(runner);
                runner = null;
            }
        }

        function runCode() {
            if (!myInterpreter) {
                // First statement of this code.
                // Clear the program output.
                resetStepUi(true);
                runButton.disabled = 'disabled';

                // And then show generated code in an alert.
                // In a timeout to allow the outputArea.value to reset first.
                setTimeout(function () {
                    console.log(latestCode);
                    //alert('Ready to execute the following code\n' +
                    //    '===================================\n' +
                    //    latestCode);

                    // Begin execution
                    highlightPause = false;
                    myInterpreter = new Interpreter(latestCode, initApi);
                    runner = function () {
                        if (myInterpreter) {
                            var hasMore = myInterpreter.run();
                            if (hasMore) {
                                // Execution is currently blocked by some async call.
                                // Try again later.
                                setTimeout(runner, 10);
                            } else {
                                // Program is complete.
                                outputArea.value += '\n\n<< Program complete >>';

                                resetInterpreter();
                                resetStepUi(false);
                            }
                        }
                    };
                    runner();
                }, 1);
                return;
            }
        }

        // Load the interpreter now, and upon future changes.
        generateCodeAndLoadIntoInterpreter();
        demoWorkspace.addChangeListener(function (event) {
            if (!(event instanceof Blockly.Events.Ui)) {
                // Something changed. Parser needs to be reloaded.

                resetInterpreter();
                generateCodeAndLoadIntoInterpreter();

                if (event.type == Blockly.Events.BLOCK_CREATE) {

                    //console.log();
                    var obj = event.getEventWorkspace_().getBlockById(event.blockId);

                    if (obj.type == "text_print")
                        return;
                    //var print = event.getEventWorkspace_().getAllBlocks().find(it => it.type = 'text_print');
                    //console.log(event.getEventWorkspace_().getAllBlocks());// .addTypedBlock
                    //console.log(print);
                    //event.getEventWorkspace_().addTopBlock(print);
                    var dom = Blockly.Xml.textToDom(
                        '<xml xmlns="http://www.w3.org/1999/xhtml">' +
                        '  <block type="text_print" inline="true" x="21" y="23">' +
                        ' <shadow type="text">' +
                        '<field name = "TEXT"> abc</field>' +
                        '</shadow >' +
                        '  </block>' +
                        '</xml>');


                    //Blockly.Xml.appendDomToWorkspace(dom, event.getEventWorkspace_());

                }
            }

        });

        function downloadZip() {
            zip.generateAsync({ type: "blob" }).then(function (blob) { // 1) generate the zip file
                saveAs(blob, "hello.zip");                          // 2) trigger the download
            });
        }
        function SaveBlocks() {
            var xml = Blockly.Xml.workspaceToDom(demoWorkspace, true);
            var xml_text = Blockly.Xml.domToPrettyText(xml);
            var n = formatDate(new Date());
            window.history.pushState({ dom: n }, xml_text, "?dom=" + n);

            lsh().set("savedBlockly_" + n, ({ name: "savedBlockly_" + n, val: xml_text }));
            window.alert("copy the url from the browser");
        }
        function getBlocksFromLocalStorage() {
            var arrSavedLocalStorage = [];
            var nrItems = lsh().length;

            for (var iStor = 0; iStor < nrItems; iStor++) {
                var key = lsh().key(iStor);
                //window.alert(key);
                if (key.indexOf("savedBlockly_") != 0)
                    continue;
                arrSavedLocalStorage.push(lsh().get(key));

            }
            //window.alert(arrSavedLocalStorage.length);
            return arrSavedLocalStorage;
        }
        function displayLinksSavedStorage() {

            var ls = document.getElementById("localStorageSaved");
            ls.innerHTML = tmpl("storage_tmpl", { data: getBlocksFromLocalStorage() });

            //window.alert(arrSavedLocalStorage.length);
        }
        function formatInt(number) {
            return number < 10 ? '0' + number : number;
        }
        function formatDate(date) {

            return `${formatInt(date.getFullYear())}${formatInt((date.getMonth() + 1))}${formatInt(date.getDate())}` +
                `${formatInt(date.getHours())}${formatInt(date.getMinutes())}${formatInt(date.getSeconds())}`;

        }
        /*doNotCopyToFinal*/
        displayLinksSavedStorage();
                            /*enddoNotCopyToFinal*/
    </script>

</body>
</html>